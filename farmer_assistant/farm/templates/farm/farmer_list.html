{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <!-- Base CSS -->
    <link rel="stylesheet" href="{% static 'farm/css/base.css' %}">
    <!-- Forms CSS -->
    <link rel="stylesheet" href="{% static 'farm/css/forms.css' %}">
    <!-- Farmer List Specific CSS -->
    <link rel="stylesheet" href="{% static 'farm/css/farmer-list.css' %}">
{% endblock %}


{% block content %}
{{ block.super }}
<div class="page-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title mb-2"><i class="fas fa-users me-2"></i>किसान प्रबंधन</h1>
                <p class="page-subtitle mb-0">आपके सभी किसानों का विवरण और प्रबंधन</p>
            </div>
            <a href="{% url 'farm:add_farmer_alt' %}" class="btn btn-light btn-lg shadow-sm">
                <i class="fas fa-plus me-2"></i>नया किसान जोड़ें
            </a>
        </div>
    </div>
</div>

<div class="container">
    <!-- Weather and Agriculture Information Cards -->
    <div class="row mb-4">
        <!-- Comprehensive Weather Information -->
        <div class="col-md-12 mb-4">
            <div class="weather-card">
                <div class="weather-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1"><i class="fas fa-map-marker-alt me-2"></i>{{ location|default:"नई दिल्ली, भारत" }}</h4>
                            <p class="mb-0 text-white-50">{% now "l, d F Y" %}</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-white text-primary">अपडेटेड: {% now "H:i" %}</span>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="row align-items-center">
                        <!-- Current Weather -->
                        <div class="col-md-4 text-center">
                            {% if weather %}
                            <div class="weather-icon mb-3">
                                {% if weather.weather.0.main == 'Clear' %}
                                    <i class="fas fa-sun text-warning"></i>
                                {% elif weather.weather.0.main == 'Clouds' %}
                                    <i class="fas fa-cloud text-white"></i>
                                {% elif weather.weather.0.main == 'Rain' %}
                                    <i class="fas fa-cloud-rain text-info"></i>
                                {% else %}
                                    <i class="fas fa-cloud-sun text-light"></i>
                                {% endif %}
                            </div>
                            <div class="weather-temp">{{ weather.main.temp|floatformat:0 }}°C</div>
                            <div class="weather-desc">
                                    {% if weather.weather.0.description == 'clear sky' %}
                                        साफ आसमान
                                    {% elif weather.weather.0.description == 'few clouds' %}
                                        कुछ बादल
                                    {% elif weather.weather.0.description == 'scattered clouds' %}
                                        बिखरे हुए बादल
                                    {% elif weather.weather.0.description == 'broken clouds' %}
                                        खंडित बादल
                                    {% elif weather.weather.0.description == 'shower rain' %}
                                        हल्की बारिश
                                    {% elif weather.weather.0.description == 'rain' %}
                                        बारिश
                                    {% elif weather.weather.0.description == 'thunderstorm' %}
                                        आंधी-तूफान
                                    {% elif weather.weather.0.description == 'snow' %}
                                        बर्फबारी
                                    {% elif weather.weather.0.description == 'mist' %}
                                        धुंध
                                    {% else %}
                                        {{ weather.weather.0.description }}
                                    {% endif %}
                                </div>
                                
                                <div class="d-flex justify-content-around text-center mt-4">
                                    <div class="px-2">
                                        <div class="text-white-50 small">न्यूनतम</div>
                                        <div class="fw-bold">{{ weather.main.temp_min|floatformat:0 }}°C</div>
                                    </div>
                                    <div class="vr bg-white-50"></div>
                                    <div class="px-2">
                                        <div class="text-white-50 small">अधिकतम</div>
                                        <div class="fw-bold">{{ weather.main.temp_max|floatformat:0 }}°C</div>
                                    </div>
                                </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-cloud-sun fa-3x text-muted mb-3"></i>
                                <p class="text-muted mb-0">मौसम की जानकारी उपलब्ध नहीं है</p>
                                {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-cloud-sun fa-3x text-muted mb-3"></i>
                                    <p class="text-muted mb-0">मौसम की जानकारी उपलब्ध नहीं है</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Today's Forecast -->
                        <div class="col-md-4 border-end">
                            <div class="p-3">
                                <h5 class="border-bottom pb-2 mb-3">आज का पूर्वानुमान</h5>
                                {% if weather %}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="text-center">
                                        <div class="text-muted small">सुबह</div>
                                        <i class="fas {% if weather.weather.0.main == 'Clear' %}fa-sun{% else %}fa-cloud-sun{% endif %} fa-2x my-2 {% if weather.weather.0.main == 'Clear' %}text-warning{% else %}text-muted{% endif %}"></i>
                                        <div class="fw-bold">{{ weather.main.temp|add:'-2'|floatformat:0 }}°C</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-muted small">दोपहर</div>
                                        <i class="fas {% if weather.weather.0.main == 'Clear' %}fa-sun{% else %}fa-cloud{% endif %} fa-2x my-2 {% if weather.weather.0.main == 'Clear' %}text-warning{% else %}text-secondary{% endif %}"></i>
                                        <div class="fw-bold">{{ weather.main.temp|floatformat:0 }}°C</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-muted small">शाम</div>
                                        <i class="fas fa-cloud-moon fa-2x my-2 text-secondary"></i>
                                        <div class="fw-bold">30°C</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-muted small">रात</div>
                                        <i class="fas fa-moon fa-2x my-2 text-primary"></i>
                                        <div class="fw-bold">26°C</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between small mb-2">
                                        <span>सूर्योदय: <strong>5:45 AM</strong></span>
                                        <span>सूर्यास्त: <strong>6:30 PM</strong></span>
                                    </div>
                                    <div class="progress mb-2" style="height: 5px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="d-flex justify-content-between small text-muted">
                                        <span>5:45 AM</span>
                                <div class="mt-3">
                                    <div class="alert alert-info small mb-0">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% if weather %}
                                            {% if weather.weather.0.main == 'Rain' %}
                                                आज बारिश की संभावना है। खेतों में उचित जल निकासी का प्रबंध करें।
                                            {% elif weather.main.temp > 35 %}
                                                आज तापमान अधिक है। फसलों को पर्याप्त पानी दें।
                                            {% elif weather.main.temp < 15 %}
                                                आज तापमान कम है। कोमल फसलों को ठंड से बचाएं।
                                            {% else %}
                                                आज का मौसम कृषि कार्यों के लिए अनुकूल है।
                                            {% endif %}
                                        {% else %}
                                            मौसम की जानकारी उपलब्ध नहीं है।
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weather Details -->
                        <div class="col-md-4">
                            <div class="p-3">
                                <h5 class="border-bottom pb-2 mb-3">मौसम की जानकारी</h5>
                                <div class="weather-details">
                                    {% if weather %}
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span class="text-muted"><i class="fas fa-wind me-2"></i>हवा की गति</span>
                                        <span class="fw-medium">{{ weather.wind.speed }} किमी/घंटा</span>
                                    </div>
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span class="text-muted"><i class="fas fa-tint me-2"></i>वायु दाब</span>
                                        <span class="fw-medium">{{ weather.main.pressure }} hPa</span>
                                    </div>
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span class="text-muted"><i class="fas fa-eye me-2"></i>दृश्यता</span>
                                        <span class="fw-medium">{% if weather.visibility %}{{ weather.visibility|floatformat:0 }} मीटर{% else %}N/A{% endif %}</span>
                                    </div>
                                    <div class="d-flex justify-content-between py-2 border-bottom">
                                        <span class="text-muted"><i class="fas fa-sun me-2"></i>सूर्योदय</span>
                                        <span class="fw-medium">
                                            {% with sunrise=weather.sys.sunrise|date:"H:i" %}
                                                {{ sunrise }}
                                            {% endwith %}
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between py-2">
                                        <span class="text-muted"><i class="fas fa-moon me-2"></i>सूर्यास्त</span>
                                        <span class="fw-medium">
                                            {% with sunset=weather.sys.sunset|date:"H:i" %}
                                                {{ sunset }}
                                            {% endwith %}
                                        </span>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-3">
                                        <i class="fas fa-exclamation-triangle text-warning mb-2"></i>
                                        <p class="text-muted small mb-0">मौसम का डेटा लोड नहीं किया जा सका</p>
                                    </div>
                                    {% endif %}
                                </div>
                                            <span>33° / 25°</span>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                        <div>बुधवार</div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-cloud-rain text-info me-2"></i>
                                            <span>31° / 24°</span>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center py-2">
                                        <div class="fw-bold">आज</div>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-sun text-warning me-2"></i>
                                            <span class="fw-bold">35° / 26°</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="alert alert-info small mb-0">
                                        <i class="fas fa-info-circle me-1"></i> 
                                        आज दोपहर 2-4 बजे के बीच हल्की बारिश की संभावना है।
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light border-0 d-flex justify-content-between align-items-center">
                    {% if active_alerts.exists %}
                    <div class="alert alert-warning py-1 mb-0" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>चेतावनी:</strong> {{ active_alerts.count }} सक्रिय मौसम चेतावनी{{ active_alerts.count|pluralize:"" }}
                    </div>
                    {% else %}
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i> कोई सक्रिय मौसम चेतावनी नहीं
                    </div>
                    {% endif %}
                    <div>
                        <a href="{% url 'farm:weather_dashboard' %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-chart-line me-1"></i> विस्तृत मौसम विश्लेषण देखें
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crop Management -->
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-seedling me-2"></i>फसल प्रबंधन</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>खाद डालने का उचित समय</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>कीट नियंत्रण के उपाय</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>फसल चक्र प्रबंधन</li>
                    </ul>
                    <div class="d-grid">
                        <a href="#" class="btn btn-outline-success">और जानें</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Irrigation Advice -->
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-tint me-2"></i>सिंचाई सलाह</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info small">
                        <i class="fas fa-info-circle me-2"></i>मौसम के अनुसार सिंचाई का समय निर्धारित करें।
                    </div>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-clock text-info me-2"></i>सुबह या शाम को सिंचाई करें</li>
                        <li class="mb-2"><i class="fas fa-tint-slash text-info me-2"></i>अधिक पानी देने से बचें</li>
                    </ul>
                    <div class="d-grid">
                        <a href="#" class="btn btn-outline-info">सिंचाई योजना देखें</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Farmers List with Weather Header -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <div class="row align-items-center">
                <!-- Weather Summary -->
                <div class="col-md-4 border-end">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-sun fa-3x text-warning"></i>
                        </div>
                        <div>
                            <h2 class="mb-0 fw-bold">33°C</h2>
                            <span class="text-muted">साफ आसमान</span>
                        </div>
                    </div>
                </div>
                
                <!-- Weather Details -->
                <div class="col-md-5 border-end">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="text-muted small">अनुभूत</div>
                            <div class="fw-bold">35°C</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small">नमी</div>
                            <div class="fw-bold">45%</div>
                        </div>
                        <div class="col-4">
                            <div class="text-muted small">हवा</div>
                            <div class="fw-bold">12 km/h</div>
                        </div>
                    </div>
                </div>
                
                <!-- Location and Update -->
                <div class="col-md-3 text-end">
                    <div class="text-muted small mb-1">
                        <i class="fas fa-map-marker-alt text-danger me-1"></i> लखनऊ, उत्तर प्रदेश
                    </div>
                    <div class="text-muted small">
                        <i class="far fa-clock me-1"></i> अद्यतित: 5:45 PM
                    </div>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-cloud-sun fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">मौसम की जानकारी उपलब्ध नहीं है</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Farmers List -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users me-2 text-primary"></i>किसान प्रबंधन</h5>
                    <div>
                        <a href="{% url 'farm:farmer_add' %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i> नया किसान जोड़ें
                        </a>
                    </div>
                </div>
            </div>
        <div class="card-body p-0">
            {% if farmers %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3" width="50">#</th>
                                <th>किसान का नाम</th>
                                <th>स्थान</th>
                                <th class="text-center">मौसम</th>
                                <th>संपर्क</th>
                                <th class="text-center">खेत</th>
                                <th class="text-end pe-3">कार्रवाई</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for farmer in farmers %}
                            <tr class="border-bottom">
                                <td class="ps-3 text-muted">{{ forloop.counter }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm me-3">
                                            <div class="avatar-title bg-light rounded-circle text-primary fw-bold">
                                                {{ farmer.name|slice:":1"|upper }}
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ farmer.name }}</h6>
                                            <small class="text-muted">ID: {{ farmer.id|stringformat:"05d" }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                        <span>{{ farmer.village }}</span>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="weather-widget">
                                        <i class="fas fa-sun text-warning"></i>
                                        <div class="weather-info">
                                            <span class="fw-bold">33°C</span>
                                            <small class="d-block text-muted">साफ</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <a href="tel:{{ farmer.phone_number }}" class="text-decoration-none">
                                        <i class="fas fa-phone-alt me-2 text-muted"></i>
                                        {{ farmer.phone_number }}
                                    </a>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark">
                                        <i class="fas fa-tractor me-1"></i> {{ farmer.fields.count }}
                                    </span>
                                </td>
                                <td class="text-end pe-3">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'farm:farmer_detail' farmer.id %}" class="btn btn-sm btn-light border" title="विवरण देखें" data-bs-toggle="tooltip">
                                            <i class="fas fa-eye text-primary"></i>
                                        </a>
                                        <a href="{% url 'farm:edit_farmer' farmer.id %}" class="btn btn-sm btn-light border" title="संपादित करें" data-bs-toggle="tooltip">
                                            <i class="fas fa-edit text-info"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-light border" title="मौसम जानकारी" data-bs-toggle="modal" data-bs-target="#weatherModal{{ farmer.id }}">
                                            <i class="fas fa-cloud-sun text-warning"></i>
                                        </button>
                                        <a href="#" class="btn btn-sm btn-light border" title="संदेश भेजें" data-bs-toggle="tooltip">
                                            <i class="fas fa-comment-dots text-success"></i>
                                        </a>
                                    </div>

                                    <!-- Weather Modal -->
                                    <div class="modal fade" id="weatherModal{{ farmer.id }}" tabindex="-1" aria-labelledby="weatherModalLabel{{ farmer.id }}" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-header bg-primary text-white">
                                                    <h5 class="modal-title" id="weatherModalLabel{{ farmer.id }}">
                                                        <i class="fas fa-cloud-sun me-2"></i>{{ farmer.village }} का मौसम
                                                    </h5>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="text-center mb-3">
                                                        <i class="fas fa-sun fa-4x text-warning mb-2"></i>
                                                        <h2>33°C</h2>
                                                        <p class="h5">साफ आसमान</p>
                                                    </div>
                                                    <div class="row text-center">
                                                        <div class="col-4">
                                                            <div class="text-muted small">अनुभूत</div>
                                                            <div class="fw-bold">35°C</div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="text-muted small">नमी</div>
                                                            <div class="fw-bold">45%</div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="text-muted small">हवा</div>
                                                            <div class="fw-bold">12 km/h</div>
                                                        </div>
                                                    </div>
                                                    <hr>
                                                    <h6>आज का पूर्वानुमान</h6>
                                                    <div class="d-flex justify-content-between text-center">
                                                        <div>
                                                            <div class="small">सुबह</div>
                                                            <i class="fas fa-cloud-sun text-muted"></i>
                                                            <div>28°C</div>
                                                        </div>
                                                        <div>
                                                            <div class="small">दोपहर</div>
                                                            <i class="fas fa-sun text-warning"></i>
                                                            <div>35°C</div>
                                                        </div>
                                                        <div>
                                                            <div class="small">शाम</div>
                                                            <i class="fas fa-cloud-moon text-secondary"></i>
                                                            <div>30°C</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <a href="{% url 'farm:weather_dashboard' %}?location={{ farmer.village }}" class="btn btn-primary">
                                                        <i class="fas fa-chart-line me-1"></i> विस्तृत जानकारी
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td data-label="खेत">
                                    <span class="badge badge-farms">
                                        <i class="fas fa-tractor me-1"></i> {{ farmer.farm_set.count }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end">
                                        <a href="#" class="action-btn view" title="देखें" data-bs-toggle="tooltip" data-bs-placement="top">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="#" class="action-btn edit ms-2" title="संपादित करें" data-bs-toggle="tooltip" data-bs-placement="top">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="no-farmers">
                    <i class="far fa-folder-open"></i>
                    <h4>कोई किसान नहीं मिला</h4>
                    <p class="text-muted">अभी तक कोई किसान दर्ज नहीं किया गया है। नया किसान जोड़ने के लिए ऊपर दिए गए बटन पर क्लिक करें।</p>
                    <a href="{% url 'farm:add_farmer_alt' %}" class="btn btn-primary mt-2">
                        <i class="fas fa-plus me-2"></i>पहला किसान जोड़ें
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    {% if farmers.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if farmers.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ farmers.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&laquo;</span>
                </li>
            {% endif %}
            
            {% for i in farmers.paginator.page_range %}
                {% if farmers.number == i %}
                    <li class="page-item active">
                        <span class="page-link">{{ i }} <span class="sr-only">(current)</span></span>
                    </li>
                {% else %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if farmers.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ farmers.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&raquo;</span>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
    <!-- Main JavaScript -->
    <script src="{% static 'farm/js/main.js' %}"></script>
    
    <!-- Farmer List Specific JavaScript -->
    <script src="{% static 'farm/js/farmer-list.js' %}"></script>
{% endblock %}
