{% extends 'resume/base.html' %}
{% load static %}

{% block title %}Simple Resume Builder - StudyShala{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'resume/css/builder-styles.css' %}">
{% endblock %}

    .contact-item:hover {
        background: rgba(37, 99, 235, 0.05);
    }

    .contact-item i {
        color: var(--primary-color);
        width: 20px;
        text-align: center;
    }

    .skill-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .skill-tag {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-color);
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        transition: var(--transition);
    }

    .skill-tag:hover {
        background: rgba(37, 99, 235, 0.2);
    }

    .experience-item, .education-item, .project-item {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        transition: var(--transition);
    }

    .experience-item:hover, .education-item:hover, .project-item:hover {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-sm);
    }

    .experience-item h3, .education-item h3, .project-item h3 {
        color: var(--text-color);
        margin: 0 0 0.5rem;
        font-size: 1.125rem;
        font-weight: 600;
    }

    .experience-item .company, .education-item .institution {
        color: var(--primary-color);
        font-weight: 500;
        margin-bottom: 0.5rem;
        display: block;
    }

    .date-range {
        color: var(--text-light);
        font-size: 0.875rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .description {
        color: var(--text-color);
        line-height: 1.7;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: 500;
        transition: var(--transition);
        cursor: pointer;
        border: none;
    }
    .btn-outline-danger {
        background: transparent;
        border: 1px solid #dc2626;
        color: #dc2626;
    .form-control {
        width: 100%;
        padding: 0.625rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.9375rem;
        transition: var(--transition);
    }

{% block content %}
<div class="resume-container">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="header">
            {% if resume_id %}
            <div class="mt-3">
                <a href="{% url 'resume:generate_pdf' resume_id %}" class="btn btn-light btn-lg" target="_blank">
                    <i class="fas fa-download me-2"></i>Download PDF
                </a>
            </div>
            {% endif %}
        </div>
        
        <div class="section">
            <div class="profile-img-container">
                <label for="profile_image" style="cursor: pointer;">
                    <img src="{% if resume and resume.profile_image %}{{ resume.profile_image.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" alt="Profile" class="profile-img" id="profile-preview">
                </label>
                <input type="file" id="profile_image" name="profile_image" accept="image/*" style="display: none;">
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="full_name" class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="full_name" name="full_name" value="{% if resume %}{{ resume.full_name|default:'' }}{% endif %}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="job_title" class="form-label">Professional Title</label>
                    <input type="text" class="form-control" id="job_title" name="job_title" value="{% if resume %}{{ resume.job_title|default:'' }}{% endif %}">
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="email" class="form-label">Email *</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                        <input type="email" class="form-control" id="email" name="email" value="{% if resume %}{{ resume.email|default:'' }}{% endif %}" required>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="phone" class="form-label">Phone Number</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                        <input type="tel" class="form-control" id="phone" name="phone" value="{% if resume %}{{ resume.phone|default:'' }}{% endif %}">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="linkedin" class="form-label">LinkedIn Profile</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fab fa-linkedin"></i></span>
                        <input type="url" class="form-control" id="linkedin" name="linkedin" value="{% if resume %}{{ resume.linkedin|default:'' }}{% endif %}">
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="github" class="form-label">GitHub Profile</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fab fa-github"></i></span>
                        <input type="url" class="form-control" id="github" name="github" value="{% if resume %}{{ resume.github|default:'' }}{% endif %}">
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="address" class="form-label">Address</label>
                <textarea class="form-control" id="address" name="address" rows="2">{% if resume %}{{ resume.address|default:'' }}{% endif %}</textarea>
            </div>
        </div>
        
        <!-- Professional Summary Section -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-user-tie me-2"></i>
                Professional Summary
            </h2>
            <div class="mb-3">
                <textarea class="form-control description-editor" id="summary" name="summary" rows="4" placeholder="Write a brief summary about yourself">{% if resume %}{{ resume.summary|default:'' }}{% endif %}</textarea>
            </div>
        </div>
        
        <!-- Skills Section -->
        <div class="section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="section-title">
                    <i class="fas fa-code me-2"></i>
                    Skills
                </h2>
                <button type="button" class="btn btn-sm btn-primary" id="add-skill">
                    <i class="fas fa-plus"></i> Add Skill
                </button>
            </div>
            <div id="skills-container">
                {% if resume and resume.skills.all %}
                    {% for skill in resume.skills.all %}
                    <div class="skill-item mb-2">
                        <div class="input-group">
                            <input type="text" class="form-control" name="skills[]" value="{{ skill.name }}" required>
                            <button type="button" class="btn btn-outline-danger remove-skill">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="skill-item mb-2">
                    <div class="input-group">
                        <input type="text" class="form-control" name="skills[]" placeholder="e.g., Python, JavaScript, Project Management" required>
                        <button type="button" class="btn btn-outline-danger remove-skill">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-another-skill">
                <i class="fas fa-plus"></i> Add Another Skill
            </button>
        </div>
        
        <div class="section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="section-title mb-0">Work Experience</h2>
                <button type="button" class="btn btn-sm btn-primary" id="add-experience">
                    <i class="fas fa-plus"></i> Add Experience
                </button>
            </div>
            
            <div id="experience-container">
                {% if resume and resume.experiences.all %}
                    {% for exp in resume.experiences.all %}
                    <div class="experience-item mb-4 p-3 border rounded">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control mb-2" name="exp_job_title[]" placeholder="Job Title" value="{{ exp.job_title }}" required>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control mb-2" name="exp_company[]" placeholder="Company" value="{{ exp.company }}" required>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control mb-2" name="exp_location[]" placeholder="Location" value="{{ exp.location|default:'' }}">
                            </div>
                            <div class="col-md-3">
                                <input type="month" class="form-control mb-2" name="exp_start_date[]" value="{{ exp.start_date|date:'Y-m' }}" required>
                            </div>
                            <div class="col-md-3">
                                <input type="month" class="form-control mb-2" name="exp_end_date[]" value="{% if exp.end_date %}{{ exp.end_date|date:'Y-m' }}{% endif %}" placeholder="Present">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control description-editor" name="exp_description[]" rows="3">{{ exp.description }}</textarea>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-experience">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="experience-item mb-4 p-3 border rounded">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2" name="exp_job_title[]" placeholder="Job Title" required>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2" name="exp_company[]" placeholder="Company" required>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2" name="exp_location[]" placeholder="Location">
                        </div>
                        <div class="col-md-3">
                            <input type="month" class="form-control mb-2" name="exp_start_date[]" required>
                        </div>
                        <div class="col-md-3">
                            <input type="month" class="form-control mb-2" name="exp_end_date[]" placeholder="Present">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control description-editor" name="exp_description[]" rows="3" placeholder="Describe your responsibilities and achievements"></textarea>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-experience">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title mb-0">Education</h2>
                <button type="button" class="btn btn-sm btn-primary" id="add-education">
                    <i class="fas fa-plus"></i> Add Education
                </button>
            </div>
            
            <div id="education-container">
                {% if resume and resume.educations.all %}
                    {% for edu in resume.educations.all %}
                    <div class="education-item mb-4 p-3 border rounded">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control mb-2" name="edu_degree[]" placeholder="Degree" value="{{ edu.degree }}" required>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control mb-2" name="edu_institution[]" placeholder="Institution" value="{{ edu.institution }}" required>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control mb-2" name="edu_field[]" placeholder="Field of Study" value="{{ edu.field_of_study|default:'' }}">
                            </div>
                            <div class="col-md-3">
                                <input type="month" class="form-control mb-2" name="edu_start_date[]" value="{{ edu.start_date|date:'Y-m' }}" required>
                            </div>
                            <div class="col-md-3">
                                <input type="month" class="form-control mb-2" name="edu_end_date[]" value="{% if edu.end_date %}{{ edu.end_date|date:'Y-m' }}{% endif %}" placeholder="Present">
                            </div>
                            <div class="col-12">
                                <textarea class="form-control" name="edu_notes[]" placeholder="Additional details (GPA, honors, relevant coursework, etc.)" rows="2">{{ edu.notes|default:'' }}</textarea>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-education">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="education-item mb-4 p-3 border rounded">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2" name="edu_degree[]" placeholder="Degree" required>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2" name="edu_institution[]" placeholder="Institution" required>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control mb-2" name="edu_field[]" placeholder="Field of Study">
                        </div>
                        <div class="col-md-3">
                            <input type="month" class="form-control mb-2" name="edu_start_date[]" required>
                        </div>
                        <div class="col-md-3">
                            <input type="month" class="form-control mb-2" name="edu_end_date[]" placeholder="Present">
                        </div>
                        <div class="col-12">
                            <textarea class="form-control" name="edu_notes[]" placeholder="Additional details (GPA, honors, relevant coursework, etc.)" rows="2"></textarea>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-education">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Print Styles -->
    <style media="print">
        body * {
            visibility: hidden;
        }
        .printable-area, .printable-area * {
            visibility: visible;
        }
        .printable-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            padding: 20px;
        }
        @page {
            size: A4;
            margin: 15mm 20mm;
        }
    </style>

    <!-- Action Buttons at Bottom -->
    <div class="section text-center mt-4">
        <div class="d-flex justify-content-center gap-3">
            {% if resume_id %}
                <a href="{% url 'resume:generate_pdf' resume_id %}" class="btn btn-success btn-lg" id="download-resume" target="_blank">
                    <i class="fas fa-download me-2"></i>Download PDF
                </a>
                <button type="button" class="btn btn-primary btn-lg" id="print-resume">
                    <i class="fas fa-print me-2"></i>Print Resume
                </button>
            {% else %}
                <button type="submit" class="btn btn-primary btn-lg" id="save-resume">
                    <i class="fas fa-save me-2"></i>Save Resume
                </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Print Styles -->
    <style media="print">
        /* Reset styles for print */
        @page {
            size: A4;
            margin: 15mm 15mm 15mm 20mm;
        }
        
        body {
            background: rgb(149, 126, 126) !important;
            color: black !important;
            font-size: 11pt;
            line-height: 1.5;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        /* Hide elements not needed in print */
        .no-print, .navbar, .footer, 
        #print-resume, #download-resume,
        .btn, .form-control, .form-label,
        .remove-experience, .remove-education,
        .remove-project, .add-section-btn,
        .section-header .btn {
            display: none !important;
        }
        
        /* Ensure proper print layout */
        .container {
            width: 100% !important;
            max-width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        /* Improve typography for print */
        h1, h2, h3, h4, h5, h6 {
            page-break-after: avoid;
            break-after: avoid;
        }
        
        /* Prevent page breaks inside important sections */
        .experience-item, .education-item, .project-item {
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        /* Add page break before main sections */
        .section:not(:first-child) {
            page-break-before: always;
        }
    </style>
    
    <script>
    // Simple print functionality
    document.addEventListener('DOMContentLoaded', function() {
        const printButton = document.getElementById('print-resume');
        if (printButton) {
            printButton.addEventListener('click', function() {
                // Add printable class to the resume container
                const resumeContainer = document.querySelector('.resume-container');
                resumeContainer.classList.add('printable-area');
                
                // Trigger print
                window.print();
                
                // Remove the printable class after printing
                setTimeout(() => {
                    resumeContainer.classList.remove('printable-area');
                }, 1000);
            });
        }
        
        // Log any errors with the download button
        const downloadButton = document.getElementById('download-resume');
        if (downloadButton) {
            downloadButton.addEventListener('click', function(e) {
                console.log('Download button clicked');
                // Let the default action happen
            });
        }
    });
    </script>
    
    </form>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.ckeditor.com/ckeditor5/35.4.0/classic/ckeditor.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Profile Image Preview
        document.getElementById('profile_image')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('profile-preview');
                    if (preview) preview.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // Add Skill
        document.getElementById('add-skill')?.addEventListener('click', function() {
            const container = document.getElementById('skills-container');
            if (!container) return;
            
            const newSkill = document.createElement('div');
            newSkill.className = 'skill-input-group mb-2';
            newSkill.innerHTML = `
                <div class="input-group">
                    <input type="text" class="form-control" name="skills" placeholder="e.g., Python, JavaScript, Project Management" required>
                    <button type="button" class="btn btn-outline-danger remove-skill">
                        <i class="fas fa-times"></i>
                    </button>
                </div>`;
            container.appendChild(newSkill);
            addRemoveListeners();
        });

        // Add Experience
        document.getElementById('add-experience')?.addEventListener('click', function() {
            const container = document.getElementById('experience-container');
            if (!container) return;
            
            const newExp = document.createElement('div');
            newExp.className = 'experience-item mb-4';
            newExp.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2" name="exp_job_title[]" placeholder="Job Title" required>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2" name="exp_company[]" placeholder="Company Name" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Start Date</label>
                        <input type="month" class="form-control mb-2" name="exp_start_date[]" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">End Date (leave empty if current)</label>
                        <input type="month" class="form-control mb-2" name="exp_end_date[]">
                    </div>
                    <div class="col-12">
                        <textarea class="form-control description-editor" name="exp_description[]" rows="3" placeholder="Your role, responsibilities, and achievements"></textarea>
                    </div>
                </div>
                <div class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-experience">
                        <i class="fas fa-trash"></i> हटाएं
                    </button>
                </div>`;
            container.appendChild(newExp);
            initializeEditors();
            addRemoveListeners();
        });

        // Add Education
        document.getElementById('add-education')?.addEventListener('click', function() {
            const container = document.getElementById('education-container');
            if (!container) return;
            
            const newEdu = document.createElement('div');
            newEdu.className = 'education-item mb-4';
            newEdu.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2" name="edu_degree[]" placeholder="Degree (e.g., B.Tech, MCA)" required>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2" name="edu_institution[]" placeholder="Institution Name" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">शुरुआत तिथि</label>
                        <input type="month" class="form-control mb-2" name="edu_start_date[]" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">समाप्ति तिथि (खाली छोड़ें यदि वर्तमान)</label>
                        <input type="month" class="form-control mb-2" name="edu_end_date[]">
                    </div>
                    <div class="col-12">
                        <textarea class="form-control" name="edu_notes[]" rows="2" placeholder="e.g., CGPA: 8.5/10, Dean's List, Relevant Coursework"></textarea>
                    </div>
                </div>
                <div class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-education">
                        <i class="fas fa-trash"></i> हटाएं
                    </button>
                </div>`;
            container.appendChild(newEdu);
            addRemoveListeners();
        });

        // Add Project
        document.getElementById('add-project')?.addEventListener('click', function() {
            const container = document.getElementById('projects-container');
            const newProj = document.createElement('div');
            newProj.className = 'project-item mb-4 p-3 border rounded';
            newProj.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control mb-2" name="project_name[]" placeholder="Project Name" required>
                    </div>
                    <div class="col-md-4">
                        <input type="url" class="form-control mb-2" name="project_url[]" placeholder="Project URL">
                    </div>
                    <div class="col-12">
                        <input type="text" class="form-control mb-2" name="project_tech[]" placeholder="Technologies Used (comma separated)">
                    </div>
                    <div class="col-12">
                        <textarea class="form-control description-editor" name="project_description[]" rows="3" placeholder="Project description, your role, and key achievements"></textarea>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger remove-project">
                    <i class="fas fa-trash"></i> Remove
                </button>
            `;
            container.appendChild(newProj);
            addRemoveListeners();
            initializeEditors();
        });

        // Initialize CKEditor for description fields
        function initializeEditors() {
            document.querySelectorAll('.description-editor').forEach(textarea => {
                if (!textarea.hasAttribute('data-ckeditor-initialized')) {
                    ClassicEditor
                        .create(textarea, {
                            toolbar: ['bold', 'italic', 'bulletedList', 'numberedList', 'link'],
                            heading: {
                                options: [
                                    { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                                    { model: 'heading3', view: 'h3', title: 'Heading', class: 'ck-heading_heading3' }
                                ]
                            }
                        })
                        .catch(error => {
                            console.error(error);
                        });
                    textarea.setAttribute('data-ckeditor-initialized', 'true');
                }
            });
        }

        // Add event listeners for remove buttons
        function addRemoveListeners() {
            // Remove skill
            document.querySelectorAll('.remove-skill').forEach(button => {
                button.addEventListener('click', function() {
                    const skillGroups = document.querySelectorAll('.skill-input-group');
                    if (skillGroups.length > 1) {
                        this.closest('.skill-input-group')?.remove();
                    } else if (this.previousElementSibling) {
                        this.previousElementSibling.value = '';
                    }
                });
            });

            // Remove experience
            document.querySelectorAll('.remove-experience').forEach(button => {
                button.addEventListener('click', function() {
                    const experienceItems = document.querySelectorAll('.experience-item');
                    if (experienceItems.length > 1) {
                        this.closest('.experience-item')?.remove();
                    } else {
                        alert('At least one work experience is required');
                    }
                });
            });

            // Remove education
            document.querySelectorAll('.remove-education').forEach(button => {
                button.addEventListener('click', function() {
                    const educationItems = document.querySelectorAll('.education-item');
                    if (educationItems.length > 1) {
                        this.closest('.education-item')?.remove();
                    } else {
                        alert('At least one education entry is required');
                    }
                });
            });

            // Remove Project
            document.querySelectorAll('.remove-project').forEach(button => {
                button.addEventListener('click', function() {
                    if (document.querySelectorAll('.project-item').length > 1) {
                        this.closest('.project-item').remove();
                    } else {
                        const item = this.closest('.project-item');
                        item.querySelectorAll('input, textarea').forEach(input => {
                            if (input.type !== 'button') {
                                input.value = '';
                            }
                        });
                    }
                });
            });
        }

        function initializeEditors() {
           
        }

        // Initialize all event listeners on page load
        addRemoveListeners();
        initializeEditors();
        
        // Download Resume button functionality
        document.getElementById('download-resume')?.addEventListener('click', function(e) {
            e.preventDefault();
            
            // First submit the form to save the resume
            const form = document.querySelector('form');
            const formData = new FormData(form);
            
            // Add a flag to indicate this is a save and download request
            formData.append('save_and_download', 'true');
            
            // Submit the form normally
            form.submit();
        });
    });
</script>
{% endblock %}
